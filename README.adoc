= NASM 
:source-highlighter: rouge

* link:https://www.nasm.us/[Nasm]
* link:https://cs.lmu.edu/~ray/notes/nasmtutorial/[Nasm tutorial]

== Quick start

Folder `quickstart` contains a simple example with an assembler program and some tests. 
Program found max value between three numbers.

To compile assembler code and run tests, execute this command:

----
. run_quick_start.sh
----

Result should look like this:
----
Build program for file quickstart/maxofthree.test.c
==================
Run maxofthree.test
------------------
should_found_max_of_threehen_first_number: Ok
should_found_max_of_threehen_second_number: Ok
should_found_max_of_threehen_third_number: Ok
-------------
PASSED
-------------
Tests run: 3
Tests failed:0
----


Program is define in file `maxofthree.asm`. +
Tests are written in file `maxofthree.test.c`


You can find some projects in `examples` folder.

== How to

=== Create a test in C

Create a `.c` file like simple.test.c:

[source, c]
----
include::howto/simple.test.c[]
----

Script run_simple.h comile and run tests.

[source, bash]
----
include::run_simple.sh[]
----

To write your own test, add all necessary includes in your test file.

Modify `gcc` command to add `.o` containing implementations used in your test.

=== Call assembler from a `c` file

Add function definition in `.c` file (or in an `.h` file included in `.c` file).

Call this function like any other function.

=== Run all tests in a file

To not have to enumarate all tests, we can use a script (test_generate.sh) to add main method with all tests.

Script read .c file and identify test by line starting by `TEST`.

All tests found are used to generate en main method to run them.
Main method is write before `RUN_TESTS()` text in .c file.

== Explain

=== Compile and run assembler

To compile an `asm` file and generate a `.o` file:
----
nasm -felf64 hello.asm
----

To link `.o` and generate a executable `a.out`:
----
ld hello.o
----

To run executable:
----
./a.out
----

It's possible to chain all commands:
----
nasm -felf64 hello.asm && ld hello.o && ./a.out
----

Output file can be define using `-o`:
----
nasm -felf64 hello.asm -o output.o
----

=== Run assembler from c file

With a file `.o` generated from an `asm` file, we can compile a `.c` file using it:
----
gcc callhello.c hello.o
----

A full command:
----
nasm -felf64 hello.asm && gcc callhello.c hello.o && ./a.out
----

=== Nasm

* link:https://www.nasm.us/[]
* link:https://cs.lmu.edu/~ray/notes/nasmtutorial/[]
* link:https://asmtutor.com/[]
* link:http://www.lacl.fr/tan/asm[]
* link:https://benoit-m.developpez.com/assembleur/tutoriel/[]

In french:

* link:https://openclassrooms.com/fr/courses/2288321-apprenez-a-programmer-en-assembleur-x86/2288944-votre-premier-programme[]

////
== Tests

Just call:
. run.sh maxofthree


nasm -felf64 maxofthree.asm -o maxofthree.o && . generate_test.sh maxofthree && gcc progtest/maxofthree.test.c maxofthree.o -o test.out && ./test.out


nasm -felf64 maxofthree.asm -o maxofthree.o             \ # Generate maxofthree.o from assembler
. generate_test.sh maxofthree                           \ # Generate a c file from test file
gcc progtest/maxofthree.test.c maxofthree.o -o test.out \ # Compile test file linked with assembler.o
./test.out                                                # Run test

nasm -felf64 maxofthree.asm -o target/obj/maxofthree.o && . generate_test.sh maxofthree && gcc target/src/maxofthree.test.c target/obj/maxofthree.o -o target/objtest/maxofthree.out && ./target/maxofthree.out
----
 ////